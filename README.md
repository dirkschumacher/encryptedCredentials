
# Opinionated encrypted credentials in R

[![CRAN
status](https://www.r-pkg.org/badges/version/encryptedCredentials)](https://cran.r-project.org/package=encryptedCredentials)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build
status](https://travis-ci.org/dirkschumacher/encryptedCredentials.svg?branch=master)](https://travis-ci.org/dirkschumacher/encryptedCredentials)
[![Coverage
status](https://codecov.io/gh/dirkschumacher/encryptedCredentials/branch/master/graph/badge.svg)](https://codecov.io/github/dirkschumacher/encryptedCredentials?branch=master)

*WORK IN PROGRESS: use at your own risk*

The goal of `encryptedCredentials` is to provide a simple, secure way to
store credentials (e.g.Â API keys) and other sensitive data in your R
project, in particular shiny applications or analyses.

It follows the approach of
[Rails](https://medium.com/cedarcode/rails-5-2-credentials-9b3324851336)
by creating a single, encrypted yml file that contains all your
credentials. The file is secured by a master key, which is either saved
(but not checked in) to disk or is available using environment
variables.

## Installation

You can install the released version of encryptedCredentials from
[CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("encryptedCredentials")
```

``` r
remotes::install_github("dirkschumacher/encryptedCredentials")
```

## Example

### Setup your environment

The following code generates a new, random master key and stores it in
`master.key`. It also uses the `usethis` package to git-ignore the
`master.key` file (in case you use git).

You run this function when setting up your project.

NEVER share this file with anyone.

``` r
library(encryptedCredentials)
use_encrypted_credentials()
#> Created the master.key file. Never share this file or commit it to git.
#> Created the credentials.yml.enc file. This is where your secrets are stored encryptedly.
```

The command above creates a key stored in `master.key`.

There are generally two options to supply a master key:

1.  Having a `master.key` file in your working directory
2.  Having an environment variable `R_ENCRYPTED_CRED_MASTER_KEY` with
    your key

### Store credentials

There is exported function used to replace the content in you encrypted
yml file.

``` r
write_encrypted_credentials(
  list(
    databases = list(
      postgres_url = "postgres://...",
      redit_url = "..."
    ),
    aws = list(
      access_key_id = "abcded",
      secret_access_key = "abcded"
    )
  )
)
#> It is recommended to restart your R session to remove any traces of data you just wrote to disk.
```

Everytime you call it, the key is read from the `master.key` file or
from the environment. Then the data is converted to yml, encrypted and
saved to disk in the root directory of your project.

Its content looks like this:

``` r
readLines("credentials.yml.enc")
#> [1] "626aa6d2f82e4067c3672fad1ff3acb455faf803de71cafa572a989655dabf08df6c3c27f1ae32709a476f8e402ac6e9c9fff9d345e293fd0d0050f9dc24f90b604a38c33f74466baec17798237524fdf14f35cac06058b6b6f4a1456eb12321394802584a933c96218417685f83f0899511ff6290a7257cf0131655ad190b8587f7f39cfff6"
#> [2] "a885777389f4752fe790291856ecdfb355c1fd3f57d0bb96"
```

### Access credentials in your script or on a server

To access the information simply run the following command:

``` r
credentials <- read_encrypted_credentials()
credentials
#> $databases
#> $databases$postgres_url
#> [1] "postgres://..."
#> 
#> $databases$redit_url
#> [1] "..."
#> 
#> 
#> $aws
#> $aws$access_key_id
#> [1] "abcded"
#> 
#> $aws$secret_access_key
#> [1] "abcded"
```

This function looks for a valid key either in `master.key` or in the
environment variable, decrypts the file in memory, converts the yml file
to an R object and returns it.

## Key Management

The key is either stored in `master.key` or you can pass it using the
`R_ENCRYPTED_CRED_MASTER_KEY` environment variable.

For shiny apps, the best way is probably using the environment variable,
while on personal projects (like a local R project that is checked into
git) the `master.key` approach is probably best suited.

Only the `credentials.yml.enc` is intented to be commited together with
you source code. Never share `master.key`.

## Crypto

Currently the package uses a 32 bytes long random key, generated by
`sodium::random`. It then uses `sodium::data_encrypt|decrypt` (with a
new, random nonce) to secure the credentials file. All logic is stored
in `crypt.R` and I am happy to hear any comments, suggestions or
security concerns.
