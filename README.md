
# Opinionated encrypted credentials in R

[![CRAN
status](https://www.r-pkg.org/badges/version/encryptedCredentials)](https://cran.r-project.org/package=encryptedCredentials)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)

*WORK IN PROGRESS: use at your own risk*

The goal of `encryptedCredentials` is to provide a simple, secure way to
store credentials (e.g.Â API keys) and other sensitive data in your R
project, in particular shiny applications or analyses.

It follows the approach of
[Rails](https://medium.com/cedarcode/rails-5-2-credentials-9b3324851336)
by creating a single, encrypted yml file that contains all your
credentials. The file is secured by a master key, which is either saved
(but not checked in) to disk or is available using environment
variables.

## Installation

You can install the released version of encryptedCredentials from
[CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("encryptedCredentials")
```

``` r
remotes::install_github("dirkschumacher/encryptedCredentials")
```

## Example

### Setup your environment

The following code generates a new, random master key and stores it in
`master.key`. It also uses the `usethis` package to git-ignore the
`master.key` file (in case you use git).

You run this function when setting up your project.

NEVER share this file with anyone.

``` r
library(encryptedCredentials)
use_encrypted_credentials()
#> Created the master.key file. Never share this file or commit it to git.
#> Created the credentials.yml.enc file. This is where your secrets are stored encryptedly.
```

There are generally two options to supply a master key:

1.  Having a `master.key` file in your working directory
2.  Having an environment variable `R_ENCRYPTED_CRED_MASTER_KEY` with
    your key

The command above creates a key stored in `master.key`.

### Store credentials

There is exported function used to replace the content in you encrypted
yml file.

``` r
write_encrypted_credentials(
  list(
    databases = list(
      postgres_url = "postgres://...",
      redit_url = "..."
    ),
    aws = list(
      access_key_id = "abcded",
      secret_access_key = "abcded"
    )
  )
)
#> It is recommended to restart your R session to remove any traces of data you just wrote to disk.
```

Everytime you call it, the key is read from the `master.key` file or
from the environment. Then the data is converted to yml, encrypted and
saved to disk in the root directory of your project.

Its content looks like this:

``` r
readLines("credentials.yml.enc")
#> [1] "1dada6a114f975ab9c4f07df7f103e50df31d2878071c133a7dd8eff916a8c076f486f2d41e8403c7e9d592bf1f29a1a34f52ac89d2e38877eaea364dff8579d919f63b31c0bcbc8eab0c050f2979042add993933ae2e3e419aacfec52a31270c77511e4266c38d7153a06468a59920dcdcf4d565c0544855566d7e91d3e69347253d6b3cfc1"
#> [2] "afbe5496d1861fa49da6023f44253ad9fd46ddbcb86be12d"
```

### Access credentials in your script or on a server

To access the information simply run the following command:

``` r
credentials <- read_encrypted_credentials()
credentials
#> $databases
#> $databases$postgres_url
#> [1] "postgres://..."
#> 
#> $databases$redit_url
#> [1] "..."
#> 
#> 
#> $aws
#> $aws$access_key_id
#> [1] "abcded"
#> 
#> $aws$secret_access_key
#> [1] "abcded"
```

This function looks for a valid key either in `master.key` or in the
environment variable, decrypts the file in memory, converts the yml file
to an R object and returns it.

## Key Management

The key is either stored in `master.key` or you can pass it using the
`R_ENCRYPTED_CRED_MASTER_KEY` environment variable.

For shiny apps, the best way is probably using the environment variable,
while on personal projects (like a local R project that is checked into
git) the `master.key` approach is probably best suited.

Only the `credentials.yml.enc` is intented to be commited together with
you source code. Never share `master.key`.

## Crypto

Currently the package uses a 32 bytes long random key, generated by
`sodium::random`. It then uses `sodium::data_encrypt|decrypt` (with a
new, random nonce) to secure the credentials file. All logic is stored
in `crypt.R` and I am happy to hear any comments, suggestions or
security concerns.
